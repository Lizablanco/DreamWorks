{% extends 'base.html' %}
{% load static %}

{% block title %}{{ pelicula.titulo }} – Detalles{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Título -->
  <h1 class="mb-4 text-center">
    {{ pelicula.titulo }} ({{ pelicula.fecha_lanzamiento.year }})
  </h1>

  <!-- Póster + Datos -->
  <div class="row justify-content-center align-items-start mb-5">
    <div class="col-md-5 poster-container text-center">
      <img
        src="{% static 'core/posters/'|add:pelicula.slug|add:'.jpg' %}"
        class="img-fluid rounded mb-3"
        alt="Póster de {{ pelicula.titulo }}"
        onerror="this.onerror=null;this.src='{% static 'core/img/default-poster.jpg' %}';">
    </div>

    <div class="col-md-7">
      <div class="info-frame p-4">
        {% if pelicula.descripcion %}
          <p>{{ pelicula.descripcion }}</p>
        {% else %}
          <p class="text-muted">Sin descripción disponible.</p>
        {% endif %}

        {% if pelicula.duracion %}
          <p><strong>Duración:</strong> {{ pelicula.duracion }} minutos</p>
        {% else %}
          <p class="text-muted">Duración no especificada.</p>
        {% endif %}

        {% if pelicula.autores %}
          <p><strong>Autores/Estudio:</strong> {{ pelicula.autores }}</p>
        {% else %}
          <p class="text-muted">Autor o estudio no registrado.</p>
        {% endif %}

        {% if pelicula.enlace_externo %}
          <a href="{{ pelicula.enlace_externo }}" class="btn btn-warning me-2" target="_blank">
            Ver película en línea
          </a>
        {% endif %}
        {% if not pelicula.archivo and not pelicula.enlace_externo %}
          <p class="text-muted">No hay contenido disponible.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <hr>

  <!-- Géneros, Curiosidades, Descargas -->
  <div class="row g-4 mb-5">
    <div class="col-md-4">
      <div class="info-frame">
        <h2>Géneros</h2>
        <ul>
          {% for genero in pelicula.generos.all %}
            <li>
              <strong>{{ genero.nombre }}</strong><br>
              <small class="text-muted">{{ genero.descripcion }}</small>
            </li>
          {% empty %}
            <li class="text-muted">Sin géneros asignados.</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="col-md-4">
      <div class="info-frame">
        <h2>Curiosidades</h2>
        <ul>
          {% for curiosidad in pelicula.curiosidades.all %}
            <li><strong>{{ curiosidad.titulo }}</strong>: {{ curiosidad.descripcion }}</li>
          {% empty %}
            <li class="text-muted">No hay curiosidades registradas.</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="col-md-4">
      <div class="info-frame">
        <h2>Descargas</h2>
        <ul>
          {% for descarga in pelicula.descargas.all %}
            <li>
              {{ descarga.user.username }}
              <small class="text-muted">– {{ descarga.fecha_descarga|date:"d M Y H:i" }}</small>
            </li>
          {% empty %}
            <li class="text-muted">No se han registrado descargas.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Formulario de opinión -->
  <div class="info-frame mt-4">
    <h2>Opinión</h2>
    {% if user.is_authenticated %}
      {% if ya_opino %}
        <p class="text-muted">Ya has dejado tu opinión sobre esta película.</p>
      {% else %}
        <form method="post" action="{% url 'comment' pelicula.slug %}">
          {% csrf_token %}
          <textarea name="descripcion" class="form-control mb-2" placeholder="Escribe tu opinión..." required></textarea>
          <button type="submit" class="btn btn-opinion mt-2">Enviar opinión</button>
        </form>
      {% endif %}
    {% else %}
      <p class="text-muted">Debes iniciar sesión para dejar tu opinión.</p>
    {% endif %}
  </div>

  <!-- Opiniones y paginación -->
  <div class="info-frame mt-4">
    <h2>Opiniones de otros usuarios</h2>
    {% if opiniones %}
      <ul>
        {% for opinion in opiniones %}
          <li>
            <strong>{{ opinion.user.username }}</strong>
            <span>{{ opinion.fecha_registro|date:"d M Y H:i" }}</span>
            <p>{{ opinion.descripcion }}</p>
          </li>
        {% endfor %}
      </ul>

      {% if opiniones.paginator.num_pages > 1 %}
        <div id="paginacion-pelicula" class="paginacion-pelicula">
          {% if opiniones.has_previous %}
            <a href="?page={{ opiniones.previous_page_number }}" class="boton-medieval me-2">← Anterior</a>
          {% endif %}
          <span class="pagina-info">Página {{ opiniones.number }} de {{ opiniones.paginator.num_pages }}</span>
          {% if opiniones.has_next %}
            <a href="?page={{ opiniones.next_page_number }}" class="boton-medieval ms-2">Siguiente →</a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <p class="text-muted">No hay opiniones registradas.</p>
    {% endif %}
  </div>

  <!-- Botones finales -->
  <div class="text-center mt-4">
    {% if descargada %}
  <button class="btn btn-secondary" disabled>Ya descargada ✨</button>
{% else %}
  <a href="{% url 'pelicula_descargar' pelicula.slug %}" class="btn btn-success btn-download me-2">
    Descargar película
  </a>
{% endif %}

    <a href="{% url 'index' %}" class="boton-medieval">
      ← Volver al Reino
    </a>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
  function smoothScrollTo(startY, targetY, duration = 600) {
    let startTime = null;
    function easeInOutQuad(t) {
      return t < 0.5 ? 2*t*t : -1 + (4-2*t)*t;
    }
    function animate(time) {
      if (!startTime) startTime = time;
      const elapsed = time - startTime;
      const progress = Math.min(elapsed/duration, 1);
      const eased = easeInOutQuad(progress);
      window.scrollTo(0, startY + (targetY - startY)*eased);
      if (elapsed < duration) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(location.search);
    if (!params.has('page')) return;

    const pag = document.getElementById('paginacion-pelicula');
    if (!pag) return;

    const header = document.querySelector('header');
    const headerH = header ? header.offsetHeight : 0;
    const margin  = 20;
    const targetY = pag.getBoundingClientRect().top + window.pageYOffset - headerH - margin;
    const startY  = window.pageYOffset;

    smoothScrollTo(startY, targetY, 600);
  });
</script>
{% endblock %}